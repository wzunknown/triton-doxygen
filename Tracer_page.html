<!-- HTML header for doxygen 1.8.14-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Pintool tracer</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js"></script>
<link href="customdoxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">libTriton
   &#160;<span id="projectnumber">version 0.9 build 1503</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Pintool tracer </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#Tracer_description">Description</a></li>
<li class="level1"><a href="#Tracer_pintool">The Triton&#39;s pintool</a><ul><li class="level2"><a href="#Tracer_pintool_example_1">Example - Display IR</a></li>
<li class="level2"><a href="#Tracer_pintool_example_2">Example - Runtime Memory Tainting</a></li>
<li class="level2"><a href="#Tracer_pintool_example_3">Example - Runtime Register Modification</a></li>
<li class="level2"><a href="#Tracer_pintool_example_4">Example - Blacklist images</a></li>
<li class="level2"><a href="#Tracer_pintool_example_5">Example - Callback on image</a></li>
<li class="level2"><a href="#Tracer_pintool_example_6">Example - Callback on routine</a></li>
<li class="level2"><a href="#Tracer_pintool_example_7">Example - Callback on signals</a></li>
<li class="level2"><a href="#Tracer_pintool_example_8">Example - Callback on syscalls</a></li>
</ul>
</li>
</ul>
</div>
<div class="textblock"><p>[<b>internal</b>] All information about how to plug a tracer.</p>
<h1><a class="anchor" id="Tracer_description"></a>
Description</h1>
<hr/>
<div class="image">
<img src="https://triton.quarkslab.com/files/triton_v06_architecture.png"/>
</div>
<p>The Triton library allows you to plug any kind of tracers. E.g: Pin, Valgrind and even a database. To use the <code>libTriton</code>, your tracer must provide two kinds of information at each program point:</p>
<ul>
<li>The current opcode executed.</li>
<li>A state context (register and memory).</li>
</ul>
<p>Based on these two information, Triton will translate the control flow into <a class="el" href="py_AstNode_page.html">AstNode</a>. As an example, let assume that you have dumped a trace into a database with all registers state and memory access - these information may come from Valgrind, Pin, Qemu or whatever. The following Python code uses the Triton's API to build the semantics of each instruction stored in the database.</p>
<div class="fragment"><div class="line"><span class="comment">#!/usr/bin/env python2</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">import</span>  sys</div><div class="line"><span class="keyword">import</span>  struct</div><div class="line"></div><div class="line"><span class="keyword">from</span> triton  <span class="keyword">import</span> ARCH, Instruction, MemoryAccess</div><div class="line"><span class="keyword">from</span> database <span class="keyword">import</span> Manager</div><div class="line"></div><div class="line">unpack_size = {1: <span class="stringliteral">&#39;B&#39;</span>, 2: <span class="stringliteral">&#39;H&#39;</span>, 4: <span class="stringliteral">&#39;I&#39;</span>, 8: <span class="stringliteral">&#39;Q&#39;</span>, 16: <span class="stringliteral">&#39;QQ&#39;</span>}</div><div class="line"></div><div class="line"><span class="keywordflow">if</span> __name__ == <span class="stringliteral">&#39;__main__&#39;</span>:</div><div class="line">    <span class="comment"># Get the current Triton context</span></div><div class="line">    ctxt = getTritonContext()</div><div class="line"></div><div class="line">    <span class="comment"># Connect to the database</span></div><div class="line">    db = Manager().connect()</div><div class="line"></div><div class="line">    <span class="comment"># inst_id is the instruction id into the database.</span></div><div class="line">    inst_id = 1</div><div class="line"></div><div class="line">    <span class="keywordflow">while</span> <span class="keyword">True</span>:</div><div class="line"></div><div class="line">        <span class="comment"># Get opcode (from database)</span></div><div class="line">        opcode = db.get_opcode_from_inst_id(inst_id)</div><div class="line">        <span class="keywordflow">if</span> opcode <span class="keywordflow">is</span> <span class="keywordtype">None</span>:</div><div class="line">            <span class="keywordflow">break</span></div><div class="line"></div><div class="line">        <span class="comment"># Get concrete register value (from database)</span></div><div class="line">        regs = db.get_registers_from_inst_id(inst_id)</div><div class="line"></div><div class="line">        <span class="comment"># Build the Triton instruction</span></div><div class="line">        inst = Instruction()</div><div class="line"></div><div class="line">        <span class="comment"># Setup opcode</span></div><div class="line">        inst.setOpcode(opcode)</div><div class="line"></div><div class="line">        <span class="comment"># Setup Address</span></div><div class="line">        inst.setAddress(regs[<span class="stringliteral">&#39;rip&#39;</span>])</div><div class="line"></div><div class="line">        <span class="comment"># Update concrete register state</span></div><div class="line">        ctxt.setConcreteRegisterValue(ctxt.registers.rax,    regs[<span class="stringliteral">&#39;rax&#39;</span>])</div><div class="line">        ctxt.setConcreteRegisterValue(ctxt.registers.rbx,    regs[<span class="stringliteral">&#39;rbx&#39;</span>])</div><div class="line">        ctxt.setConcreteRegisterValue(ctxt.registers.rcx,    regs[<span class="stringliteral">&#39;rcx&#39;</span>])</div><div class="line">        ctxt.setConcreteRegisterValue(ctxt.registers.rdx,    regs[<span class="stringliteral">&#39;rdx&#39;</span>])</div><div class="line">        ctxt.setConcreteRegisterValue(ctxt.registers.rdi,    regs[<span class="stringliteral">&#39;rdi&#39;</span>])</div><div class="line">        ctxt.setConcreteRegisterValue(ctxt.registers.rsi,    regs[<span class="stringliteral">&#39;rsi&#39;</span>])</div><div class="line">        ctxt.setConcreteRegisterValue(ctxt.registers.rbp,    regs[<span class="stringliteral">&#39;rbp&#39;</span>])</div><div class="line">        ctxt.setConcreteRegisterValue(ctxt.registers.rsp,    regs[<span class="stringliteral">&#39;rsp&#39;</span>])</div><div class="line">        ctxt.setConcreteRegisterValue(ctxt.registers.rip,    regs[<span class="stringliteral">&#39;rip&#39;</span>])</div><div class="line">        ctxt.setConcreteRegisterValue(ctxt.registers.r8,     regs[<span class="stringliteral">&#39;r8&#39;</span>])</div><div class="line">        ctxt.setConcreteRegisterValue(ctxt.registers.r9,     regs[<span class="stringliteral">&#39;r9&#39;</span>])</div><div class="line">        ctxt.setConcreteRegisterValue(ctxt.registers.r10,    regs[<span class="stringliteral">&#39;r10&#39;</span>])</div><div class="line">        ctxt.setConcreteRegisterValue(ctxt.registers.r11,    regs[<span class="stringliteral">&#39;r11&#39;</span>])</div><div class="line">        ctxt.setConcreteRegisterValue(ctxt.registers.r12,    regs[<span class="stringliteral">&#39;r12&#39;</span>])</div><div class="line">        ctxt.setConcreteRegisterValue(ctxt.registers.r13,    regs[<span class="stringliteral">&#39;r13&#39;</span>])</div><div class="line">        ctxt.setConcreteRegisterValue(ctxt.registers.r14,    regs[<span class="stringliteral">&#39;r14&#39;</span>])</div><div class="line">        ctxt.setConcreteRegisterValue(ctxt.registers.r15,    regs[<span class="stringliteral">&#39;r15&#39;</span>])</div><div class="line">        ctxt.setConcreteRegisterValue(ctxt.registers.eflags, regs[<span class="stringliteral">&#39;eflags&#39;</span>])</div><div class="line">        ctxt.setConcreteRegisterValue(ctxt.registers.fs,     regs[<span class="stringliteral">&#39;fs&#39;</span>]) <span class="comment"># The mapped base address</span></div><div class="line">        ctxt.setConcreteRegisterValue(ctxt.registers.gs,     regs[<span class="stringliteral">&#39;gs&#39;</span>]) <span class="comment"># The mapped base address</span></div><div class="line"></div><div class="line">        <span class="comment"># Update concrete memory access</span></div><div class="line">        accesses = db.get_memory_access_from_inst_id(inst_id)</div><div class="line"></div><div class="line">        <span class="comment"># Update memory access</span></div><div class="line">        <span class="keywordflow">for</span> access <span class="keywordflow">in</span> accesses:</div><div class="line">            <span class="keywordflow">if</span> access[<span class="stringliteral">&#39;kind&#39;</span>] == <span class="stringliteral">&#39;R&#39;:                address = access[&#39;addr&#39;</span>]</div><div class="line">                data    = access[<span class="stringliteral">&#39;data&#39;</span>]</div><div class="line">                value   = struct.unpack(unpack_size[len(data)], data)[0]</div><div class="line">                ctxt.setConcreteMemoryValue(MemoryAccess(address, len(data), value))</div><div class="line"></div><div class="line">        <span class="comment"># Process everything (build IR, spread taint, perform simplification, ...)</span></div><div class="line">        ctxt.processing(inst)</div><div class="line"></div><div class="line">        <span class="comment"># At this point, all engines inside the Triton library were been synchronized with the concrete state.</span></div><div class="line">        <span class="comment"># Display instruction</span></div><div class="line">        <span class="keywordflow">print</span> inst</div><div class="line"></div><div class="line">        <span class="comment"># Display symbolic expressions</span></div><div class="line">        <span class="keywordflow">for</span> expr <span class="keywordflow">in</span> inst.getSymbolicExpressions():</div><div class="line">            <span class="keywordflow">print</span> <span class="stringliteral">&#39;\t&#39;</span>, expr</div><div class="line"></div><div class="line">        <span class="comment"># Next instruction (from the database)</span></div><div class="line">        inst_id += 1</div><div class="line">    sys.exit(0)</div></div><!-- fragment --><p>The database connection is a pure example to show how to interact with the Triton API. As Triton is written in <code>C++</code>, you can directly create your Triton instruction inside a DBI engine (like Pin or Valgrind). According to your tracer, you can refer to the <a href="https://triton.quarkslab.com/documentation/doxygen/py_triton_page.html">Python</a> or the <a href="https://triton.quarkslab.com/documentation/doxygen/classtriton_1_1API.html">C++</a> API.</p>
<h1><a class="anchor" id="Tracer_pintool"></a>
The Triton's pintool</h1>
<hr/>
<p>This project is shippied with a pintool as tracer. Basically, you can add callbacks, get current registers and memory values, inject values into registers and memory, start and stop analysis at specific points, select what images are jitted or not, interact with the Triton API and many more... All information about the pintool API is describe at this following page <a class="el" href="pintool_py_page.html#pintool_py_api">Python API - Methods and namespaces of the Pintool tracer</a>. Below, some examples.</p>
<hr/>
 <h2><a class="anchor" id="Tracer_pintool_example_1"></a>
Example - Display IR</h2>
<div class="fragment"><div class="line"><span class="comment">#!/usr/bin/env python2</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">from</span> pintool <span class="keyword">import</span> *</div><div class="line"><span class="keyword">from</span> triton  <span class="keyword">import</span> ARCH</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">def </span>mycb(inst):</div><div class="line">    print(inst)</div><div class="line">    <span class="keywordflow">for</span> expr <span class="keywordflow">in</span> inst.getSymbolicExpressions():</div><div class="line">        print(expr)</div><div class="line">    <span class="keywordflow">print</span></div><div class="line">    <span class="keywordflow">return</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordflow">if</span> __name__ == <span class="stringliteral">&#39;__main__&#39;</span>:</div><div class="line">    <span class="comment"># Start JIT at the entry point</span></div><div class="line">    <a class="code" href="group__options.html#ga6a8234601f1c87695e1b0d6f49f3caee">startAnalysisFromEntry</a>()</div><div class="line"></div><div class="line">    <span class="comment"># Add callback</span></div><div class="line">    insertCall(mycb, INSERT_POINT.BEFORE)</div><div class="line"></div><div class="line">    <span class="comment"># Run Program</span></div><div class="line">    runProgram()</div></div><!-- fragment --><hr/>
 <h2><a class="anchor" id="Tracer_pintool_example_2"></a>
Example - Runtime Memory Tainting</h2>
<div class="fragment"><div class="line"></div><div class="line"><span class="comment"># Using: $ ./build/triton ./src/examples/pin/runtime_memory_tainting.py ./src/samples/crackmes/crackme_xor a</span></div><div class="line"></div><div class="line"><span class="keyword">from</span> triton  <span class="keyword">import</span> ARCH</div><div class="line"><span class="keyword">from</span> pintool <span class="keyword">import</span> *</div><div class="line"></div><div class="line">GREEN = <span class="stringliteral">&quot;\033[92m&quot;</span></div><div class="line">ENDC  = <span class="stringliteral">&quot;\033[0m&quot;</span></div><div class="line"></div><div class="line">Triton = getTritonContext()</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment"># 0x40058b: movzx eax, byte ptr [rax]</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment"># When the instruction located in 0x40058b is executed,</span></div><div class="line"><span class="comment"># we taint the memory that RAX holds.</span></div><div class="line"><span class="keyword">def </span>cbeforeSymProc(instruction):</div><div class="line">    <span class="keywordflow">if</span> instruction.getAddress() == 0x400574:</div><div class="line">        rax = <a class="code" href="group__context.html#ga15b6e6ea645a0bc2e9b2c0cee6b32507">getCurrentRegisterValue</a>(Triton.registers.rax)</div><div class="line">        Triton.taintMemory(rax)</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">def </span>cafter(instruction):</div><div class="line">    print(<span class="stringliteral">&#39;%#x: %s&#39;</span> %(instruction.getAddress(), instruction.getDisassembly()))</div><div class="line">    <span class="keywordflow">for</span> se <span class="keywordflow">in</span> instruction.getSymbolicExpressions():</div><div class="line">        <span class="keywordflow">if</span> se.isTainted() == <span class="keyword">True</span>:</div><div class="line">            print(<span class="stringliteral">&#39;\t -&gt; %s%s%s&#39;</span> %(GREEN, se.getAst(), ENDC))</div><div class="line">        <span class="keywordflow">else</span>:</div><div class="line">            print(<span class="stringliteral">&#39;\t -&gt; %s&#39;</span> %(se.getAst()))</div><div class="line">    <span class="keywordflow">print</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordflow">if</span> __name__ == <span class="stringliteral">&#39;__main__&#39;</span>:</div><div class="line">    <span class="comment"># Start the symbolic analysis from the &#39;check&#39; function</span></div><div class="line">    <a class="code" href="group__options.html#ga7a10302688ec539b3a18f842bc311aba">startAnalysisFromSymbol</a>(<span class="stringliteral">&#39;check&#39;</span>)</div><div class="line"></div><div class="line">    insertCall(cbeforeSymProc,  INSERT_POINT.BEFORE_SYMPROC)</div><div class="line">    insertCall(cafter,          INSERT_POINT.AFTER)</div><div class="line"></div><div class="line">    <span class="comment"># Run the instrumentation - Never returns</span></div><div class="line">    runProgram()</div><div class="line"></div></div><!-- fragment --><hr/>
 <h2><a class="anchor" id="Tracer_pintool_example_3"></a>
Example - Runtime Register Modification</h2>
<div class="fragment"><div class="line"><span class="comment">#!/usr/bin/env python2</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">import</span> sys</div><div class="line"><span class="keyword">from</span>   pintool <span class="keyword">import</span> *</div><div class="line"><span class="keyword">from</span>   triton  <span class="keyword">import</span> ARCH</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">def </span>cb1(inst):</div><div class="line">    <span class="keywordflow">if</span> inst.getAddress() == 0x4005e2:</div><div class="line">        <a class="code" href="group__context.html#gae7c09d8a7061254d1f955f4f4cd5d25e">setCurrentRegisterValue</a>(getTritonContext().registers.rax, 0)</div><div class="line"></div><div class="line"><span class="keyword">def </span>cb2(inst):</div><div class="line">    <span class="keywordflow">if</span> inst.getAddress() == 0x4005e2:</div><div class="line">        print(inst)</div><div class="line">        <span class="keywordflow">for</span> expr <span class="keywordflow">in</span> inst.getSymbolicExpressions():</div><div class="line">            print(<span class="stringliteral">&#39;\t %s&#39;</span> %(expr))</div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordflow">if</span> __name__ == <span class="stringliteral">&#39;__main__&#39;</span>:</div><div class="line">    setupImageWhitelist([<span class="stringliteral">&#39;crackme&#39;</span>])</div><div class="line">    <a class="code" href="group__options.html#ga7a10302688ec539b3a18f842bc311aba">startAnalysisFromSymbol</a>(<span class="stringliteral">&#39;main&#39;</span>)</div><div class="line">    insertCall(cb1, INSERT_POINT.BEFORE_SYMPROC)</div><div class="line">    insertCall(cb2, INSERT_POINT.BEFORE)</div><div class="line">    runProgram()</div></div><!-- fragment --><hr/>
 <h2><a class="anchor" id="Tracer_pintool_example_4"></a>
Example - Blacklist images</h2>
<div class="fragment"><div class="line"></div><div class="line"><span class="keyword">from</span> triton  <span class="keyword">import</span> ARCH</div><div class="line"><span class="keyword">from</span> pintool <span class="keyword">import</span> *</div><div class="line"></div><div class="line"><span class="comment"># Output</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment"># $ ./build/triton ./src/examples/pin/blacklist.py ./src/samples/crackmes/crackme_xor a</span></div><div class="line"><span class="comment"># 0x4005ca: push rbp</span></div><div class="line"><span class="comment"># 0x4005cb: mov rbp, rsp</span></div><div class="line"><span class="comment"># 0x4005ce: sub rsp, 0x20</span></div><div class="line"><span class="comment"># 0x4005d2: mov dword ptr [rbp-0x14], edi</span></div><div class="line"><span class="comment"># 0x4005d5: mov qword ptr [rbp-0x20], rsi</span></div><div class="line"><span class="comment"># 0x4005d9: cmp dword ptr [rbp-0x14], 0x2</span></div><div class="line"><span class="comment"># 0x4005dd: jz 0x4005e6</span></div><div class="line"><span class="comment"># 0x4005e6: mov rax, qword ptr [rbp-0x20]</span></div><div class="line"><span class="comment"># 0x4005ea: add rax, 0x8</span></div><div class="line"><span class="comment"># 0x4005ee: mov rax, qword ptr [rax]</span></div><div class="line"><span class="comment"># 0x4005f1: mov rdi, rax</span></div><div class="line"><span class="comment"># 0x4005f4: call 0x40056d</span></div><div class="line"><span class="comment"># 0x40056d: push rbp</span></div><div class="line"><span class="comment"># 0x40056e: mov rbp, rsp</span></div><div class="line"><span class="comment"># 0x400571: mov qword ptr [rbp-0x18], rdi</span></div><div class="line"><span class="comment"># 0x400575: mov dword ptr [rbp-0x4], 0x0</span></div><div class="line"><span class="comment"># 0x40057c: jmp 0x4005bd</span></div><div class="line"><span class="comment"># 0x4005bd: cmp dword ptr [rbp-0x4], 0x4</span></div><div class="line"><span class="comment"># 0x4005c1: jle 0x40057e</span></div><div class="line"><span class="comment"># 0x40057e: mov eax, dword ptr [rbp-0x4]</span></div><div class="line"><span class="comment"># 0x400581: movsxd rdx, eax</span></div><div class="line"><span class="comment"># 0x400584: mov rax, qword ptr [rbp-0x18]</span></div><div class="line"><span class="comment"># 0x400588: add rax, rdx</span></div><div class="line"><span class="comment"># 0x40058b: movzx eax, byte ptr [rax]</span></div><div class="line"><span class="comment"># 0x40058e: movsx eax, al</span></div><div class="line"><span class="comment"># 0x400591: sub eax, 0x1</span></div><div class="line"><span class="comment"># 0x400594: xor eax, 0x55</span></div><div class="line"><span class="comment"># 0x400597: mov ecx, eax</span></div><div class="line"><span class="comment"># 0x400599: mov rdx, qword ptr [rip+0x200aa0]</span></div><div class="line"><span class="comment"># 0x4005a0: mov eax, dword ptr [rbp-0x4]</span></div><div class="line"><span class="comment"># 0x4005a3: cdqe</span></div><div class="line"><span class="comment"># 0x4005a5: add rax, rdx</span></div><div class="line"><span class="comment"># 0x4005a8: movzx eax, byte ptr [rax]</span></div><div class="line"><span class="comment"># 0x4005ab: movsx eax, al</span></div><div class="line"><span class="comment"># 0x4005ae: cmp ecx, eax</span></div><div class="line"><span class="comment"># 0x4005b0: jz 0x4005b9</span></div><div class="line"><span class="comment"># 0x4005b2: mov eax, 0x1</span></div><div class="line"><span class="comment"># 0x4005b7: jmp 0x4005c8</span></div><div class="line"><span class="comment"># 0x4005c8: pop rbp</span></div><div class="line"><span class="comment"># 0x4005c9: ret</span></div><div class="line"><span class="comment"># 0x4005f9: mov dword ptr [rbp-0x4], eax</span></div><div class="line"><span class="comment"># 0x4005fc: cmp dword ptr [rbp-0x4], 0x0</span></div><div class="line"><span class="comment"># 0x400600: jnz 0x40060e</span></div><div class="line"><span class="comment"># 0x40060e: mov edi, 0x4006ce</span></div><div class="line"><span class="comment"># 0x400613: call 0x400450</span></div><div class="line"><span class="comment"># 0x400450: jmp qword ptr [rip+0x200bc2]</span></div><div class="line"><span class="comment"># 0x400456: push 0x0</span></div><div class="line"><span class="comment"># 0x40045b: jmp 0x400440</span></div><div class="line"><span class="comment"># loose</span></div><div class="line"><span class="comment"># 0x400618: mov eax, dword ptr [rbp-0x4]</span></div><div class="line"><span class="comment"># 0x40061b: leave</span></div><div class="line"><span class="comment"># $</span></div><div class="line"></div><div class="line"><span class="keyword">def </span>mycb(instruction):</div><div class="line">    print(<span class="stringliteral">&#39;%#x: %s&#39;</span> %(instruction.getAddress(), instruction.getDisassembly()))</div><div class="line">    <span class="keywordflow">return</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordflow">if</span> __name__ == <span class="stringliteral">&#39;__main__&#39;</span>:</div><div class="line">    <span class="comment"># libc and ld-linux will be unjited</span></div><div class="line">    setupImageBlacklist([<span class="stringliteral">&quot;libc&quot;</span>, <span class="stringliteral">&quot;ld-linux&quot;</span>])</div><div class="line"></div><div class="line">    <a class="code" href="group__options.html#ga7a10302688ec539b3a18f842bc311aba">startAnalysisFromSymbol</a>(<span class="stringliteral">&#39;main&#39;</span>)</div><div class="line">    insertCall(mycb, INSERT_POINT.BEFORE)</div><div class="line">    runProgram()</div></div><!-- fragment --><hr/>
 <h2><a class="anchor" id="Tracer_pintool_example_5"></a>
Example - Callback on image</h2>
<div class="fragment"><div class="line"></div><div class="line"><span class="keyword">from</span> triton  <span class="keyword">import</span> ARCH</div><div class="line"><span class="keyword">from</span> pintool <span class="keyword">import</span> *</div><div class="line"></div><div class="line"><span class="comment"># Output</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment"># $ ./build/triton ./src/examples/pin/callback_image.py ./src/samples/ir_test_suite/ir</span></div><div class="line"><span class="comment"># ----------</span></div><div class="line"><span class="comment"># Image path:  /dir/Triton/samples/ir_test_suite/ir</span></div><div class="line"><span class="comment"># Image base:  0x400000L</span></div><div class="line"><span class="comment"># Image size:  2101312</span></div><div class="line"><span class="comment"># ----------</span></div><div class="line"><span class="comment"># Image path:  /lib64/ld-linux-x86-64.so.2</span></div><div class="line"><span class="comment"># Image base:  0x7fb9a14d9000L</span></div><div class="line"><span class="comment"># Image size:  2236744</span></div><div class="line"><span class="comment"># ----------</span></div><div class="line"><span class="comment"># Image path:  /lib64/libc.so.6</span></div><div class="line"><span class="comment"># Image base:  0x7fb98b739000L</span></div><div class="line"><span class="comment"># Image size:  3766680</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">def </span>image(imagePath, imageBase, imageSize):</div><div class="line">    print(<span class="stringliteral">&#39;----------&#39;</span>)</div><div class="line">    print(<span class="stringliteral">&#39;Image path: &#39;</span>, imagePath)</div><div class="line">    print(<span class="stringliteral">&#39;Image base: &#39;</span>, hex(imageBase))</div><div class="line">    print(<span class="stringliteral">&#39;Image size: &#39;</span>, imageSize)</div><div class="line">    <span class="keywordflow">return</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordflow">if</span> __name__ == <span class="stringliteral">&#39;__main__&#39;</span>:</div><div class="line">    <span class="comment"># Start the symbolic analysis from the Entry point</span></div><div class="line">    <a class="code" href="group__options.html#ga6a8234601f1c87695e1b0d6f49f3caee">startAnalysisFromEntry</a>()</div><div class="line"></div><div class="line">    <span class="comment"># Add a callback.</span></div><div class="line">    insertCall(image, INSERT_POINT.IMAGE_LOAD)</div><div class="line"></div><div class="line">    <span class="comment"># Run the instrumentation - Never returns</span></div><div class="line">    runProgram()</div></div><!-- fragment --><hr/>
 <h2><a class="anchor" id="Tracer_pintool_example_6"></a>
Example - Callback on routine</h2>
<div class="fragment"><div class="line"></div><div class="line"><span class="keyword">from</span> triton  <span class="keyword">import</span> ARCH</div><div class="line"><span class="keyword">from</span> pintool <span class="keyword">import</span> *</div><div class="line"></div><div class="line"><span class="comment"># Output</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment"># $ ./build/triton ./src/examples/pin/callback_routine.py  ./src/samples/vulns/testSuite</span></div><div class="line"><span class="comment"># -&gt; malloc(0x20)</span></div><div class="line"><span class="comment"># &lt;- 0x8fc010</span></div><div class="line"><span class="comment"># -&gt; malloc(0x20)</span></div><div class="line"><span class="comment"># &lt;- 0x8fc040</span></div><div class="line"><span class="comment"># -&gt; malloc(0x20)</span></div><div class="line"><span class="comment"># &lt;- 0x8fc010</span></div><div class="line"></div><div class="line">Triton = getTritonContext()</div><div class="line"></div><div class="line"><span class="keyword">def </span>mallocEntry(threadId):</div><div class="line">    sizeAllocated = <a class="code" href="group__context.html#ga15b6e6ea645a0bc2e9b2c0cee6b32507">getCurrentRegisterValue</a>(Triton.registers.rdi)</div><div class="line">    print(<span class="stringliteral">&#39;-&gt; malloc(%#x)&#39;</span> %(sizeAllocated))</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">def </span>mallocExit(threadId):</div><div class="line">    ptrAllocated = <a class="code" href="group__context.html#ga15b6e6ea645a0bc2e9b2c0cee6b32507">getCurrentRegisterValue</a>(Triton.registers.rax)</div><div class="line">    print(<span class="stringliteral">&#39;&lt;- %#x&#39;</span> %(ptrAllocated))</div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordflow">if</span> __name__ == <span class="stringliteral">&#39;__main__&#39;</span>:</div><div class="line">    <span class="comment"># Start the symbolic analysis from the Entry point</span></div><div class="line">    <a class="code" href="group__options.html#ga6a8234601f1c87695e1b0d6f49f3caee">startAnalysisFromEntry</a>()</div><div class="line"></div><div class="line">    <span class="comment"># Add a callback.</span></div><div class="line">    insertCall(mallocEntry, INSERT_POINT.ROUTINE_ENTRY, <span class="stringliteral">&quot;malloc&quot;</span>)</div><div class="line">    insertCall(mallocExit, INSERT_POINT.ROUTINE_EXIT, <span class="stringliteral">&quot;malloc&quot;</span>)</div><div class="line"></div><div class="line">    <span class="comment"># Run the instrumentation - Never returns</span></div><div class="line">    runProgram()</div></div><!-- fragment --><hr/>
 <h2><a class="anchor" id="Tracer_pintool_example_7"></a>
Example - Callback on signals</h2>
<div class="fragment"><div class="line"></div><div class="line"><span class="keyword">from</span> triton <span class="keyword">import</span> *</div><div class="line"><span class="keyword">from</span> pintool <span class="keyword">import</span> *</div><div class="line"></div><div class="line"><span class="comment"># Output</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment">#  $ ./build/triton ./src/examples/pin/callback_signals.py ./src/samples/others/signals</span></div><div class="line"><span class="comment">#  Signal 11 received on thread 0.</span></div><div class="line"><span class="comment">#  ========================== DUMP ==========================</span></div><div class="line"><span class="comment">#  rax:    0x00000000000000                        ((_ zero_extend 32) (_ bv234 32))</span></div><div class="line"><span class="comment">#  rbx:    0x00000000000000                        UNSET</span></div><div class="line"><span class="comment">#  rcx:    0x00000000001ba4                        ((_ zero_extend 32) ((_ extract 31 0) #81))</span></div><div class="line"><span class="comment">#  rdx:    0x0000000000000b                        ((_ sign_extend 32) ((_ extract 31 0) #34))</span></div><div class="line"><span class="comment">#  rdi:    0x00000000001ba4                        ((_ sign_extend 32) ((_ extract 31 0) #83))</span></div><div class="line"><span class="comment">#  rsi:    0x00000000001ba4                        ((_ sign_extend 32) ((_ extract 31 0) #90))</span></div><div class="line"><span class="comment">#  rbp:    0x007fff097e3540                        ((_ extract 63 0) #0)</span></div><div class="line"><span class="comment">#  rsp:    0x007fff097e3528                        (bvsub ((_ extract 63 0) #47) (_ bv8 64))</span></div><div class="line"><span class="comment">#  rip:    0x007f3fa0735ea7                        (_ bv139911251582629 64)</span></div><div class="line"><span class="comment">#  r8:     0x007f3fa0a94c80                        UNSET</span></div><div class="line"><span class="comment">#  r9:     0x007f3fb671b120                        UNSET</span></div><div class="line"><span class="comment">#  r10:    0x00000000000000                        UNSET</span></div><div class="line"><span class="comment">#  r11:    0x007f3fa0735e70                        UNSET</span></div><div class="line"><span class="comment">#  r12:    0x00000000400460                        UNSET</span></div><div class="line"><span class="comment">#  r13:    0x007fff097e3620                        UNSET</span></div><div class="line"><span class="comment">#  r14:    0x00000000000000                        UNSET</span></div><div class="line"><span class="comment">#  r15:    0x00000000000000                        UNSET</span></div><div class="line"><span class="comment">#  xmm0:   0x000000ff000000                        UNSET</span></div><div class="line"><span class="comment">#  xmm1:   0x2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f      UNSET</span></div><div class="line"><span class="comment">#  xmm2:   0x00000000000000                        UNSET</span></div><div class="line"><span class="comment">#  xmm3:   0x00ff000000ff00                        UNSET</span></div><div class="line"><span class="comment">#  xmm4:   0x000000000000ff                        UNSET</span></div><div class="line"><span class="comment">#  xmm5:   0x00000000000000                        UNSET</span></div><div class="line"><span class="comment">#  xmm6:   0x00000000000000                        UNSET</span></div><div class="line"><span class="comment">#  xmm7:   0x00000000000000                        UNSET</span></div><div class="line"><span class="comment">#  xmm8:   0x00000000000000                        UNSET</span></div><div class="line"><span class="comment">#  xmm9:   0x00000000000000                        UNSET</span></div><div class="line"><span class="comment">#  xmm10:  0x00000000000000                        UNSET</span></div><div class="line"><span class="comment">#  xmm11:  0x00000000000000                        UNSET</span></div><div class="line"><span class="comment">#  xmm12:  0x00000000000000                        UNSET</span></div><div class="line"><span class="comment">#  xmm13:  0x00000000000000                        UNSET</span></div><div class="line"><span class="comment">#  xmm14:  0x00000000000000                        UNSET</span></div><div class="line"><span class="comment">#  xmm15:  0x00000000000000                        UNSET</span></div><div class="line"><span class="comment">#  af:     0x00000000000000                        (ite (= (_ bv16 64) (bvand (_ bv16 64) (bvxor #12 (bvxor ((_ extract 63 0) #0) (_ bv16 64))))) (_ bv1 1) (_ bv0 1))</span></div><div class="line"><span class="comment">#  cf:     0x00000000000000                        (_ bv0 1)</span></div><div class="line"><span class="comment">#  df:     0x00000000000000                        UNSET</span></div><div class="line"><span class="comment">#  if:     0x00000000000001                        UNSET</span></div><div class="line"><span class="comment">#  of:     0x00000000000000                        (_ bv0 1)</span></div><div class="line"><span class="comment">#  pd:     0x00000000000001                        (ite (= (parity_flag ((_ extract 7 0) #73)) (_ bv0 1)) (_ bv1 1) (_ bv0 1))</span></div><div class="line"><span class="comment">#  sf:     0x00000000000000                        (ite (= ((_ extract 31 31) #73) (_ bv1 1)) (_ bv1 1) (_ bv0 1))</span></div><div class="line"><span class="comment">#  tf:     0x00000000000000                        UNSET</span></div><div class="line"><span class="comment">#  zf:     0x00000000000001                        (ite (= #73 (_ bv0 32)) (_ bv1 1) (_ bv0 1))</span></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">def </span><a class="code" href="group__callback.html#ga8fdee2fb1bb34707d9eafa0f631fba20">signals</a>(threadId, sig):</div><div class="line">    print(<span class="stringliteral">&#39;Signal %d received on thread %d.&#39;</span> %(sig, threadId))</div><div class="line">    print(<span class="stringliteral">&#39;========================== DUMP ==========================&#39;</span>)</div><div class="line">    regs = getTritonContext().getParentRegisters()</div><div class="line">    <span class="keywordflow">for</span> reg <span class="keywordflow">in</span> regs:</div><div class="line">        value = <a class="code" href="group__context.html#ga15b6e6ea645a0bc2e9b2c0cee6b32507">getCurrentRegisterValue</a>(reg)</div><div class="line">        expr  = getTritonContext().getSymbolicRegister(reg)</div><div class="line">        print(<span class="stringliteral">&#39;%s:\t%#016x\t%s&#39;</span> %(reg.getName(), value, (expr.getAst() <span class="keywordflow">if</span> expr <span class="keywordflow">is</span> <span class="keywordflow">not</span> <span class="keywordtype">None</span> <span class="keywordflow">else</span> <span class="stringliteral">&#39;UNSET&#39;</span>)))</div><div class="line">    <span class="keywordflow">return</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordflow">if</span> __name__ == <span class="stringliteral">&#39;__main__&#39;</span>:</div><div class="line">    <span class="comment"># Start the symbolic analysis from the Entry point</span></div><div class="line">    <a class="code" href="group__options.html#ga6a8234601f1c87695e1b0d6f49f3caee">startAnalysisFromEntry</a>()</div><div class="line"></div><div class="line">    <span class="comment"># Add a callback.</span></div><div class="line">    insertCall(signals, INSERT_POINT.SIGNALS)</div><div class="line"></div><div class="line">    <span class="comment"># Run the instrumentation - Never returns</span></div><div class="line">    runProgram()</div></div><!-- fragment --><hr/>
 <h2><a class="anchor" id="Tracer_pintool_example_8"></a>
Example - Callback on syscalls</h2>
<div class="fragment"><div class="line"></div><div class="line"><span class="keyword">from</span> triton  <span class="keyword">import</span> ARCH, SYSCALL64</div><div class="line"><span class="keyword">from</span> pintool <span class="keyword">import</span> *</div><div class="line"></div><div class="line"><span class="comment"># Output</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment"># $ ./build/triton ./src/examples/pin/callback_syscall.py  ./src/samples/crackmes/crackme_xor a</span></div><div class="line"><span class="comment"># sys_write(1, 7fb7f06e1000, 6)</span></div><div class="line"><span class="comment"># loose</span></div><div class="line"><span class="comment">#</span></div><div class="line"></div><div class="line"><span class="keyword">def </span>my_callback_syscall_entry(threadId, std):</div><div class="line">    <span class="keywordflow">if</span> getSyscallNumber(std) == SYSCALL64.WRITE:</div><div class="line">        arg0 = getSyscallArgument(std, 0)</div><div class="line">        arg1 = getSyscallArgument(std, 1)</div><div class="line">        arg2 = getSyscallArgument(std, 2)</div><div class="line">        print(<span class="stringliteral">&#39;sys_write(%x, %x, %x)&#39;</span> %(arg0, arg1, arg2))</div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordflow">if</span> __name__ == <span class="stringliteral">&#39;__main__&#39;</span>:</div><div class="line">    <span class="comment"># Start the symbolic analysis from the Entry point</span></div><div class="line">    <a class="code" href="group__options.html#ga6a8234601f1c87695e1b0d6f49f3caee">startAnalysisFromEntry</a>()</div><div class="line"></div><div class="line">    insertCall(my_callback_syscall_entry, INSERT_POINT.SYSCALL_ENTRY)</div><div class="line"></div><div class="line">    <span class="comment"># Run the instrumentation - Never returns</span></div><div class="line">    runProgram()</div></div><!-- fragment --> </div></div><!-- contents -->
<!-- HTML footer for doxygen 1.8.14-->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
